

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="ja" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="ja" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Microservice &mdash; test_sphinx 1.0.0 ドキュメント</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript" src="_static/translations.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="検索" href="search.html" />
    <link rel="next" title="Web API" href="WebAPI.html" />
    <link rel="prev" title="Docker" href="Docker.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> test_sphinx
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Spring-Core.html">Spring Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spring-Boot.html">Spring Boot</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spring-Session.html">Spring Session</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spring-Security.html">Spring Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spring-MVC.html">Spring MVC</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spring-Web.html">Spring Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spring-Data.html">Spring Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="MyBatis3.html">MyBatis3</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spring-to-Spring-boot.html">SpringからSpring bootへの移行</a></li>
<li class="toctree-l1"><a class="reference internal" href="Docker.html">Docker</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Microservice</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#ec">簡易ECサイトののマイクロサービスアーキテクチャ化</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">サービス分割単位</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">各サービスの主な業務機能</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">各サービスの主なシステム機能</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">システム全体構成（ヘキサゴナルアーキテクチャ）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#goods-servicerest-api">Goods ServiceのREST APIの設計と実装</a></li>
<li class="toctree-l3"><a class="reference internal" href="#account-serivcerest-api">Account SerivceのREST APIの設計と実装</a></li>
<li class="toctree-l3"><a class="reference internal" href="#order-serivcesaga-transaction">Order SerivceのSaga Transactionの設計と実装</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="WebAPI.html">Web API</a></li>
<li class="toctree-l1"><a class="reference internal" href="git.html">git</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lombok.html">Lombok</a></li>
<li class="toctree-l1"><a class="reference internal" href="Linux.html">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sphinx.html">Sphinx</a></li>
</ul>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="UX.html">UX</a></li>
<li class="toctree-l1"><a class="reference internal" href="UI.html">UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="Design-Process.html">デザインプロセス</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">test_sphinx</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Microservice</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/Microservice.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="microservice">
<h1>Microservice<a class="headerlink" href="#microservice" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="ec">
<h2>簡易ECサイトののマイクロサービスアーキテクチャ化<a class="headerlink" href="#ec" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>terasolunaチュートリアルの簡易ECサイトを使って、マイクロサービスアーキテクチャ移行検証を行った。</p>
<div class="section" id="id1">
<h3>サービス分割単位<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>terasolunaチュートリアルの簡易ECサイトを、Goods Service（商品）と、Account Serive（アカウント）、Order Service（注文）に機能分割する。
Order Serviceは、Goods ServiceとAccount Serviceを呼び出すBFFであり、
Account ServiceとGoods Serviceは、BFFから呼び出される、マイクロサービスである。
マイクロサービスを跨いだ、トランザクション処理が発生しないように分割する。例えば、簡易ECサイトの場合だと、Goods Serivceのトランザクション
はAccount Serviceが持つデータを更新しないようにする（逆方向も同様）。</p>
<div class="figure align-center" id="id5">
<a class="reference internal image-reference" href="./_static/img/overview.png"><img alt="" src="./_static/img/overview.png" /></a>
<p class="caption"><span class="caption-text">全体イメージ（モノリシック vs マイクロサービス）</span></p>
</div>
</div>
<div class="section" id="id2">
<h3>各サービスの主な業務機能<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="31%" />
<col width="31%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">サービス</th>
<th class="head">機能</th>
<th class="head">内容</th>
<th class="head">備考</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Order</td>
<td>商品注文</td>
<td>カートに入った商品の購入手続きを行う</td>
<td>注文確定処理時に、商品の在庫確認と購入者の購入額上限をチェック</td>
</tr>
<tr class="row-odd"><td>Goods</td>
<td>商品取得</td>
<td>指定した商品IDに一致する商品を取得する</td>
<td>--</td>
</tr>
<tr class="row-even"><td>Goods</td>
<td>商品カテゴリ取得</td>
<td>指定した商品カテゴリに一致する商品を取得する</td>
<td>--</td>
</tr>
<tr class="row-odd"><td>Goods</td>
<td>商品情報更新</td>
<td>商品情報（商品詳細、在庫情報等）を更新する</td>
<td>商品情報更新時、在庫がマイナスでないかチェック</td>
</tr>
<tr class="row-even"><td>Account</td>
<td>アカウント取得</td>
<td>指定したEmailアドレスやIDに一致するアカウントを取得する</td>
<td>--</td>
</tr>
<tr class="row-odd"><td>Account</td>
<td>アカウント情報更新</td>
<td>アカウント情報（ユーザ基本情報、累積購入額、購入額上限等）を更新する</td>
<td>アカウント情報更新時、累積購入額が購入額上限を上回らないかチェック</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id3">
<h3>各サービスの主なシステム機能<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="44%" />
<col width="44%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">サービス</th>
<th class="head">機能</th>
<th class="head">内容</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Order</td>
<td>認証・認可</td>
<td>Accountサービスが保持するアカウント情報とSpring Securityをつかって認証・認可機能を提供する</td>
</tr>
<tr class="row-odd"><td>Order</td>
<td>分散トランザクション管理</td>
<td>商品注文機能が扱う、GoodsとAccountが保持するデータの整合性担保のため、Sagaを使った分散トランザクション管理を行う</td>
</tr>
<tr class="row-even"><td>Goods</td>
<td>RET APIサービス</td>
<td>業務機能をREST APIで提供する</td>
</tr>
<tr class="row-odd"><td>Account</td>
<td>REST APIサービス</td>
<td>業務機能をREST APIで提供する</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id4">
<h3>システム全体構成（ヘキサゴナルアーキテクチャ）<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="figure align-center" id="id6">
<a class="reference internal image-reference" href="../_static/img/hexArchitecture.png"><img alt="" src="../_static/img/hexArchitecture.png" /></a>
<p class="caption"><span class="caption-text">システム全体構成（ヘキサゴナルアーキテクチャ）</span></p>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">ヘキサゴナルアーキテクチャでは、内側の中央の六角形はBusiness logicを表し、外側の六角形は外部とのAdapterを表す。
ポイントは、Business logicは、外側のAdapterには依存しないということ。</p>
</div>
<p>参考: Microservice Patterns, Chris Richardson</p>
</div>
<div class="section" id="goods-servicerest-api">
<h3>Goods ServiceのREST APIの設計と実装<a class="headerlink" href="#goods-servicerest-api" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><strong>API一覧</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="5%" />
<col width="19%" />
<col width="19%" />
<col width="19%" />
<col width="19%" />
<col width="19%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">機能</th>
<th class="head">method</th>
<th class="head">Query Parameter</th>
<th class="head">Request Body</th>
<th class="head">Response Body</th>
<th class="head">Status Code</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>カテゴリIDによる商品一覧取得</td>
<td>get</td>
<td>categoryId/offset/limit</td>
<td>--</td>
<td>GoodsResource[]</td>
<td>200/400</td>
</tr>
<tr class="row-odd"><td>商品IDによる商品詳細取得</td>
<td>get</td>
<td>goodsId</td>
<td>--</td>
<td>GoodsResource</td>
<td>200/400</td>
</tr>
<tr class="row-even"><td>商品情報更新</td>
<td>put</td>
<td>goodsId</td>
<td>Goods</td>
<td>Goods[]</td>
<td>200/400</td>
</tr>
</tbody>
</table>
<p><strong>実装概要</strong></p>
<p>MVCアプリケーションと比べた場合、REST APIサービスでは、以下の特徴がある。
Serviceクラス以下のクラスについては、Webアプリケーションと同様の実装となるため、
元々の簡易ECサイトのソースコードをそのまま使っている。
一方、Controllerクラスにおいて、MVCアプリケーションでは、画面からの入力をFormクラスで受け取り、Viewを返すが、
REST APIサービスでは、クエリパラメータ等でREST Clietからの入力を受け取り、Resourceオブジェクトを返す。</p>
<p><strong>Contorollerクラス</strong></p>
<p>以下は「カテゴリIDによる商品一覧取得」のAPIに対応するContorollerクラスの抜粋である。&#64;RequestParamで受け取ったクエリパラーメータの値を、Serviceクラスに渡し
ModelクラスのGoodsのListを受け取っている。それを、Mapperを使ってResourceクラスに変換している。
なお、以下のAPIは、offsetとlimitの指定で、指定したカテゴリIDに一致したGoodsの一部を返却しているが、
総件数については、レスポンスヘッダーに入れている。
また、BusinessExceptionは、throwsし例外ハンドラに例外処理は、委譲している。</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span>//omitted

@RestController
@RequestMapping<span class="o">(</span><span class="s2">&quot;api/v1&quot;</span><span class="o">)</span>
public class GoodsRestController <span class="o">{</span>

@Autowired
GoodsService goodsService<span class="p">;</span>

@Autowired
Mapper beanMapper<span class="p">;</span>

@GetMapping<span class="o">(</span><span class="s2">&quot;/goods&quot;</span><span class="o">)</span>
public ResponseEntity&lt;List&lt;Goods&gt;&gt; getGoodsByCategoryId<span class="o">(</span>@RequestParam<span class="o">(</span><span class="nv">name</span> <span class="o">=</span> <span class="s2">&quot;categoryId&quot;</span>, <span class="nv">defaultValue</span> <span class="o">=</span> <span class="s2">&quot;1&quot;</span><span class="o">)</span> Integer categoryId,
                                                        @RequestParam<span class="o">(</span><span class="nv">name</span> <span class="o">=</span> <span class="s2">&quot;offset&quot;</span>, <span class="nv">required</span> <span class="o">=</span> false, <span class="nv">defaultValue</span> <span class="o">=</span> <span class="s2">&quot;0&quot;</span><span class="o">)</span> Integer offset,
                                                        @RequestParam<span class="o">(</span><span class="nv">name</span> <span class="o">=</span> <span class="s2">&quot;limit&quot;</span>, <span class="nv">required</span> <span class="o">=</span> false, <span class="nv">defaultValue</span> <span class="o">=</span> <span class="s2">&quot;10&quot;</span><span class="o">)</span> Integer limit<span class="o">)</span> throws BusinessException <span class="o">{</span>

    List&lt;Goods&gt; <span class="nv">goodsList</span> <span class="o">=</span> goodsService.findByCategoryId<span class="o">(</span>categoryId, offset, limit<span class="o">)</span><span class="p">;</span>
    List&lt;GoodsResource&gt; <span class="nv">goodsResourcesList</span> <span class="o">=</span> new ArrayList&lt;&gt;<span class="o">()</span><span class="p">;</span>
    <span class="k">for</span> <span class="o">(</span>Goods goods : goodsList<span class="o">)</span> <span class="o">{</span>
        goodsResourcesList.add<span class="o">(</span>beanMapper.map<span class="o">(</span>goods, GoodsResource.class<span class="o">))</span><span class="p">;</span>
    <span class="o">}</span>

    HttpHeaders <span class="nv">headers</span> <span class="o">=</span> new HttpHeaders<span class="o">()</span><span class="p">;</span>
    Long <span class="nv">total</span> <span class="o">=</span> goodsService.getTotalWithCategoryId<span class="o">(</span>categoryId<span class="o">)</span><span class="p">;</span>
    headers.add<span class="o">(</span><span class="s2">&quot;X-Total-Count&quot;</span>, String.valueOf<span class="o">(</span>total<span class="o">))</span><span class="p">;</span>

    <span class="k">return</span> new ResponseEntity&lt;&gt;<span class="o">(</span>
            goodsList,
            headers,
            HttpStatus.OK<span class="o">)</span><span class="p">;</span>

<span class="o">}</span>

//omitted
</pre></div>
</td></tr></table></div>
<p><strong>Resourceクラス</strong></p>
<p>MVCアプリケーションには存在しないREST APIサービス特有のクラスである。
サービス内部の業務ロジックで用いるドメインオブジェクトと、サービス外部提向けに提供する際の、情報は異る可能性を考慮し、
Modelクラスとは別に、Resourceクラスを用意する。</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span>//omitted

@AllArgsConstructor
@NoArgsConstructor
@Builder
@Data
public class GoodsResource implements Serializable <span class="o">{</span>

    private static final long <span class="nv">serialVersionUID</span> <span class="o">=</span> 1L<span class="p">;</span>

    private String id<span class="p">;</span>

    private String name<span class="p">;</span>

    private String description<span class="p">;</span>

    private int categoryId<span class="p">;</span>

    private int price<span class="p">;</span>

    private int stock<span class="p">;</span>

<span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Modelクラス</strong></p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span>//omitted

@AllArgsConstructor
@NoArgsConstructor
@Builder
@Data
public class Goods implements Serializable <span class="o">{</span>

    private static final long <span class="nv">serialVersionUID</span> <span class="o">=</span> 1L<span class="p">;</span>

    private String id<span class="p">;</span>

    private String name<span class="p">;</span>

    private String description<span class="p">;</span>

    private int categoryId<span class="p">;</span>

    private int price<span class="p">;</span>

    private int stock<span class="p">;</span>

    @Override
    public boolean equals<span class="o">(</span>Object obj<span class="o">)</span> <span class="o">{</span>

        <span class="k">if</span> <span class="o">(</span>!<span class="o">(</span>obj instanceof Goods<span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> false<span class="p">;</span>
        <span class="o">}</span>

        <span class="k">return</span> id.equals<span class="o">(((</span>Goods<span class="o">)</span> obj<span class="o">)</span>.getId<span class="o">())</span><span class="p">;</span>
    <span class="o">}</span>

    @Override
    public int hashCode<span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> id.hashCode<span class="o">()</span><span class="p">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Serivceクラス</strong></p>
<p>以下は商品情報更新処理のServiceクラスのメソッドである。REST Clientから送られたきた商品のStockが、0を下回るとき、
ビジネス例外をthrowする。そうでない場合は、Repositoryクラスを呼び、データを永続化する。</p>
<p><strong>Repositoryクラス</strong></p>
<p>MyBatis3を使った、Repositoryクラスの実装である。</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span>//omitted

@Repository
@Mapper
public interface GoodsRepository <span class="o">{</span>

    List&lt;Goods&gt; findPageByCategoryId<span class="o">(</span>Integer categoryId, RowBounds rowBounds<span class="o">)</span><span class="p">;</span>

    Goods findById<span class="o">(</span>String id<span class="o">)</span><span class="p">;</span>

    List&lt;Integer&gt; getAllCategories<span class="o">()</span><span class="p">;</span>

    long countByCategoryId<span class="o">(</span>int categoryId<span class="o">)</span><span class="p">;</span>

    boolean updateById<span class="o">(</span>Goods goods<span class="o">)</span><span class="p">;</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>MyBatisマッピングファイル</strong></p>
<p>Modelクラスのオブジェクトを返り値として受け取りたい場合は、
resultMapで、オブジェクトフィールド名とテーブルのカラム名を対応づける。</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span>&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span>?&gt;
&lt;!DOCTYPE mapper PUBLIC <span class="s2">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
        <span class="s2">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;
&lt;mapper <span class="nv">namespace</span><span class="o">=</span><span class="s2">&quot;com.example.good.domain.repository.GoodsRepository&quot;</span>&gt;

    &lt;resultMap <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;goodsResultMap&quot;</span> <span class="nv">type</span><span class="o">=</span><span class="s2">&quot;com.example.good.domain.model.Goods&quot;</span>&gt;
        &lt;id <span class="nv">property</span><span class="o">=</span><span class="s2">&quot;id&quot;</span> <span class="nv">column</span><span class="o">=</span><span class="s2">&quot;goods_id&quot;</span> /&gt;
        &lt;result <span class="nv">property</span><span class="o">=</span><span class="s2">&quot;name&quot;</span> <span class="nv">column</span><span class="o">=</span><span class="s2">&quot;goods_name&quot;</span> /&gt;
        &lt;result <span class="nv">property</span><span class="o">=</span><span class="s2">&quot;description&quot;</span> <span class="nv">column</span><span class="o">=</span><span class="s2">&quot;description&quot;</span> /&gt;
        &lt;result <span class="nv">property</span><span class="o">=</span><span class="s2">&quot;categoryId&quot;</span> <span class="nv">column</span><span class="o">=</span><span class="s2">&quot;category_id&quot;</span> /&gt;
        &lt;result <span class="nv">property</span><span class="o">=</span><span class="s2">&quot;price&quot;</span> <span class="nv">column</span><span class="o">=</span><span class="s2">&quot;price&quot;</span> /&gt;
        &lt;result <span class="nv">property</span><span class="o">=</span><span class="s2">&quot;stock&quot;</span> <span class="nv">column</span><span class="o">=</span><span class="s2">&quot;stock&quot;</span> /&gt;
    &lt;/resultMap&gt;

    &lt;<span class="k">select</span> <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;findPageByCategoryId&quot;</span> <span class="nv">parameterType</span><span class="o">=</span><span class="s2">&quot;int&quot;</span> <span class="nv">resultMap</span><span class="o">=</span><span class="s2">&quot;goodsResultMap&quot;</span>&gt;
        &lt;!<span class="o">[</span>CDATA<span class="o">[</span>
        SELECT
            goods_id,
            goods_name,
            description,
            category_id,
            price,
            stock
        FROM
            goods
        WHERE
            <span class="nv">category_id</span> <span class="o">=</span> <span class="c1">#{categoryId}</span>
        ORDER BY
            goods_id
        <span class="o">]]</span>&gt;
    &lt;/select&gt;

//omitted
</pre></div>
</td></tr></table></div>
<p><strong>例外ハンドリングクラス</strong></p>
<p>以下は、Contorollerクラスで発生する例外のハンドリングクラスである。&#64;ControllerAdviceのアノテーションによって、
Contorollerクラス内の各メソッドで発生する例外を横断してハンドリングできる。
以下は、ビジネス例外をハンドリングするメソッドの例である。Serviceクラスの実装サンプルで示したように、
エラーコード、エラーメッセージが格納されているbusinessExceptionをbodyに埋め込み、400エラー（BAD REQUEST）を
REST CLIENTに返している。</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span>//omitted

@ControllerAdvice
public class CommonExceptionHandler <span class="o">{</span>

    @Autowired
    Mapper beanMapper<span class="p">;</span>

    @ExceptionHandler<span class="o">(</span>BusinessException.class<span class="o">)</span>
    public ResponseEntity&lt;Object&gt; handleBusinessException<span class="o">(</span>BusinessException businessException<span class="o">){</span>
        <span class="k">return</span> new ResponseEntity&lt;&gt;<span class="o">(</span>
                beanMapper.map<span class="o">(</span>businessException, BusinessExceptionResponse.class<span class="o">)</span>,
                HttpStatus.BAD_REQUEST<span class="o">)</span><span class="p">;</span>

    <span class="o">}</span>

//omitted
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="account-serivcerest-api">
<h3>Account SerivceのREST APIの設計と実装<a class="headerlink" href="#account-serivcerest-api" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><strong>API一覧</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="5%" />
<col width="19%" />
<col width="19%" />
<col width="19%" />
<col width="19%" />
<col width="19%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">機能</th>
<th class="head">method</th>
<th class="head">Query Parameter</th>
<th class="head">Request Body</th>
<th class="head">Response Body</th>
<th class="head">Status Code</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>アカウントIDによるアカウント取得</td>
<td>get</td>
<td>id</td>
<td>--</td>
<td>AccountResource</td>
<td>200/400</td>
</tr>
<tr class="row-odd"><td>Emailによるアカウント取得</td>
<td>post</td>
<td>--</td>
<td>LoginId</td>
<td>AccountResource</td>
<td>200/400</td>
</tr>
<tr class="row-even"><td>アカウント作成</td>
<td>post</td>
<td>--</td>
<td>AccountCreateResource</td>
<td>※locationヘッダーに、作成したアカウントのURIを付与</td>
<td>200/400</td>
</tr>
<tr class="row-odd"><td>アカウント更新</td>
<td>put</td>
<td>--</td>
<td>AccountUpdateResource</td>
<td>--</td>
<td>204/400</td>
</tr>
</tbody>
</table>
<p><strong>Contorollerクラス</strong></p>
<p>以下は「アカウント更新」のAPIに対応するContorollerクラスの実装である。
Goods Seriviceとの実装上の違いは、リクエストボディの引数に、&#64;Validatedを付けて、バリデーション処理を行っている。
バリデーション例外が発生した場合は、例外ハンドラクラスで、ハンドリングを行う。</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span>//omitted

@PutMapping<span class="o">(</span><span class="s2">&quot;/account&quot;</span><span class="o">)</span>
@ResponseStatus<span class="o">(</span>HttpStatus.NO_CONTENT<span class="o">)</span>
public void updateAccount<span class="o">(</span>@RequestParam<span class="o">(</span><span class="nv">name</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span><span class="o">)</span> String id,
                        @Validated @RequestBody AccountUpdateResource accountUpdateResource<span class="o">)</span> throws BusinessException<span class="o">{</span>
    Account <span class="nv">account</span> <span class="o">=</span> beanMapper.map<span class="o">(</span>accountUpdateResource, Account.class<span class="o">)</span><span class="p">;</span>
    account.setId<span class="o">(</span>id<span class="o">)</span><span class="p">;</span>
    accountService.update<span class="o">(</span>account<span class="o">)</span><span class="p">;</span>
<span class="o">}</span>

//omitted
</pre></div>
</td></tr></table></div>
<p><strong>Resourceクラス</strong></p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span>//omitted

public class AccountUpdateResource implements  Serializable<span class="o">{</span>
    private static final long <span class="nv">serialVersionUID</span> <span class="o">=</span> 1L<span class="p">;</span>

    private String id<span class="p">;</span>

    @NotNull
    @Size<span class="o">(</span><span class="nv">min</span> <span class="o">=</span> <span class="m">1</span>, <span class="nv">max</span> <span class="o">=</span> <span class="m">255</span><span class="o">)</span>
    private String name<span class="p">;</span>

//omitted
</pre></div>
</td></tr></table></div>
<p><strong>Serivceクラス</strong></p>
<p>以下は、アカウント更新処理メソッドの実装である。REST CLIENTから累計購入金額が購入額上限を上回った場合、
ビジネス例外をthrowする。そうでない場合は、Repositoryクラスを呼び、データを永続化する。</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span>//omitted

public void update<span class="o">(</span>Account account<span class="o">)</span> throws BusinessException <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span>parseInt<span class="o">(</span>account.getCreditCharge<span class="o">())</span> &gt; parseInt<span class="o">(</span>account.getCreditLimit<span class="o">())){</span>
        String <span class="nv">errorCode</span> <span class="o">=</span> <span class="s2">&quot;BE0003&quot;</span><span class="p">;</span>
        throw new BusinessException<span class="o">(</span>errorCode, messageSource.getMessage<span class="o">(</span>
                errorCode, new String<span class="o">[]{</span>account.getCreditCharge<span class="o">()</span>, account.getCreditLimit<span class="o">()}</span>, Locale.getDefault<span class="o">()))</span><span class="p">;</span>

    <span class="o">}</span><span class="k">else</span><span class="o">{</span>
        accountRepository.updateById<span class="o">(</span>account<span class="o">)</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>例外ハンドリングクラス</strong></p>
</div>
<div class="section" id="order-serivcesaga-transaction">
<h3>Order SerivceのSaga Transactionの設計と実装<a class="headerlink" href="#order-serivcesaga-transaction" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>商品注文処理を、Goods ServiceとAccount Serviceを呼び出して実現する。
ポイントは、Goods Serviceもしくは、Account Serviceで例外が発生した際に、
適切に補償トランザクションを実行しデータの整合性を保つことである。</p>
<p><strong>Sagaにおける補償トランザクション</strong></p>
<p>補償トランザクションとは、フォーワードトランザクション実行で失敗が発生した際、
失敗以前に行った変更を、打ち消すトランザクションである。
例えば、以下の例では、フォーワードトランザクションTn+1が失敗した場合、補償トランザクションCnからC1を実行している。</p>
<div class="figure align-center" id="id7">
<a class="reference internal image-reference" href="../_static/img/conpensatingTransaction.png"><img alt="" src="../_static/img/conpensatingTransaction.png" /></a>
<p class="caption"><span class="caption-text">補償トランザクションの実行イメージ</span></p>
</div>
<p>引用: Microservice Patterns, Chris Richardson</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">補償トランザクションは、フォーワードトランザクションと逆順で実行する点に注意する。</p>
</div>
<p><strong>フォーワードトランザクションと補償トランザクションの一覧</strong></p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="29%" />
<col width="29%" />
<col width="29%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Step</th>
<th class="head">Service</th>
<th class="head">Forward Transaction</th>
<th class="head">Compensating Transaction</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>Order Service</td>
<td>createOrder()</td>
<td>rejectOrder()</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>Order Service</td>
<td>createOrderLines()</td>
<td>deleteOrderLines()</td>
</tr>
<tr class="row-even"><td>3</td>
<td>Goods Service</td>
<td>decreaseStock()</td>
<td>increaeStok()</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>Account Service</td>
<td>addCreditCharge()</td>
<td>substractCreditCharge()</td>
</tr>
<tr class="row-even"><td>5</td>
<td>Order Service</td>
<td>approveOrdre()</td>
<td>--</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><strong>実装概要</strong></p>
<p>Order ServiceのServiceクラスから、Sagaの実行に必要な情報をSagaStateクラスに格納した後、
SagaManagerクラスから実行。Sagaの定義（各STEPのトランザクションの定義とSTEPの順序の定義）は、
SagaPaticipantクラスとSagaDefinitionクラスを使ってDIする。</p>
<div class="figure align-center" id="id8">
<a class="reference internal image-reference" href="../_static/img/sagaSequence.png"><img alt="" src="../_static/img/sagaSequence.png" /></a>
<p class="caption"><span class="caption-text">処理シーケンスイメージ</span></p>
</div>
<p><strong>SagaPaticipantクラス</strong></p>
<p>以下の、フォーワードトランザクションと、補償トランザクションのメソッドの組み合わせを、
インタフェース定義している。ビジネス例外をthrowし、SagaParticipantを実行するSagaManagerで例外ハンドリングできるようにする。</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span>//omitted

public interface SagaParticipant <span class="o">{</span>
    void forwardTransaction<span class="o">(</span>CreateOrderSagaState createOrderSagaState<span class="o">)</span> throws BusinessException<span class="p">;</span>
    void compensatingTransaction<span class="o">(</span>CreateOrderSagaState createOrderSagaState<span class="o">)</span> throws BusinessException<span class="p">;</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p>Sagaトランザクションの各STEPは、自身が行いたい処理を実装する。
以下は、商品注文時、商品在庫を減らす処理をフォーワードトランザクションとして定義し、
商品在庫を増やす処理を補償トランザクションで定義している。</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span>//omitted

@Component<span class="o">(</span><span class="s2">&quot;goodsServiceParticipant&quot;</span><span class="o">)</span>
public class GoodsServiceParticipant implements SagaParticipant <span class="o">{</span>

    @Autowired
    GoodsService goodsService<span class="p">;</span>

    @Override
    public void forwardTransaction<span class="o">(</span>CreateOrderSagaState createOrderSagaState<span class="o">)</span> throws BusinessException <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span>OrderLine orderLine : createOrderSagaState.getOrderLines<span class="o">())</span> <span class="o">{</span>
            goodsService.decreaseStock<span class="o">(</span>orderLine.getGoods<span class="o">()</span>, orderLine.getQuantity<span class="o">())</span><span class="p">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    @Override
    public void compensatingTransaction<span class="o">(</span>CreateOrderSagaState createOrderSagaState<span class="o">)</span> throws BusinessException<span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span>OrderLine orderLine : createOrderSagaState.getOrderLines<span class="o">())</span> <span class="o">{</span>
            goodsService.increaseStock<span class="o">(</span>orderLine.getGoods<span class="o">()</span>, orderLine.getQuantity<span class="o">())</span><span class="p">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>SagaDefinitionクラス</strong></p>
<p>各SagaPaticipantクラスを組み合わせて、Sagaの定義を行う。
以下では、各SagaPaticipantの実装クラスを引数にして、List&lt;SagaParticipant&gt;型でSagaを定義している。
DIしておき、Sagaを実際に実行する、SagaManagerクラスから使えるようにしておく。</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span>//omitted

@Configuration
public class SagaConfig <span class="o">{</span>

    @Bean
    public CreateOrderSaga createOrderSaga<span class="o">(</span>OrderServiceParticipant orderServiceParticipant,
                                        GoodsServiceParticipant goodsServiceParticipant,
                                        AccountServiceParticipant accountServiceParticipant<span class="o">){</span>
        CreateOrderSaga <span class="nv">createOrderSaga</span> <span class="o">=</span> new CreateOrderSaga<span class="o">()</span><span class="p">;</span>
        List&lt;SagaParticipant&gt; <span class="nv">sagaDefinition</span> <span class="o">=</span> new ArrayList&lt;&gt;<span class="o">()</span><span class="p">;</span>
        sagaDefinition.add<span class="o">(</span>orderServiceParticipant<span class="o">)</span><span class="p">;</span>
        sagaDefinition.add<span class="o">(</span>goodsServiceParticipant<span class="o">)</span><span class="p">;</span>
        sagaDefinition.add<span class="o">(</span>accountServiceParticipant<span class="o">)</span><span class="p">;</span>
        createOrderSaga.setSagaDefinition<span class="o">(</span>sagaDefinition<span class="o">)</span><span class="p">;</span>
        <span class="k">return</span> createOrderSaga<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>SagaStateクラス</strong></p>
<p>Sagaの実行時に必要な状態を保持するクラス。以下は、商品注文処理に必要な、
注文商品情報やアカウント情報を保持している。</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span>//omitted

@Data
@Component
public class CreateOrderSagaState extends SagaState<span class="o">{</span>
    private Order order<span class="p">;</span>
    private List&lt;OrderLine&gt; orderLines<span class="p">;</span>
    private Account account<span class="p">;</span>


    public CreateOrderSagaState<span class="o">(</span>Order order, List&lt;OrderLine&gt; orderLines, Account account<span class="o">){</span>
        super<span class="o">()</span><span class="p">;</span>
        this.order <span class="o">=</span> order<span class="p">;</span>
        this.orderLines <span class="o">=</span> orderLines<span class="p">;</span>
        this.account <span class="o">=</span> account<span class="p">;</span>

    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>SagaManagerクラス</strong></p>
<p>Sagaの定義と状態を使って、実際にSagaを実行するクラス。
各Stepの実行事に発生するビジネス例外をキャッチした場合は、完了済のSTEPの補償トランザクションを
逆順に実行していく。補償トランザクションを実行した場合は、ビジネス例外をthrowし、Controllerクラスで例外ハンドリングし
ユーザに注文完了できないことを通知する。</p>
<div class="highlight-bash notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span>//omitted

@Component
public class CreateOrderSagaManager <span class="o">{</span>

    @Autowired
    MessageSource messageSource<span class="p">;</span>


    @Autowired
    CreateOrderSaga createOrderSaga<span class="p">;</span>

    public void create <span class="o">(</span>CreateOrderSagaState createOrderSagaState<span class="o">)</span> throws BusinessException<span class="o">{</span>
        List&lt;SagaParticipant&gt; <span class="nv">sagaDefinition</span> <span class="o">=</span> createOrderSaga.getSagaDefinition<span class="o">()</span><span class="p">;</span>
        Deque&lt;SagaParticipant&gt; <span class="nv">sagaParticipantDoneList</span> <span class="o">=</span> new ArrayDeque&lt;&gt;<span class="o">()</span><span class="p">;</span>

        <span class="k">for</span> <span class="o">(</span>SagaParticipant sagaParticipant : sagaDefinition<span class="o">){</span>
            try<span class="o">{</span>
                sagaParticipant.forwardTransaction<span class="o">(</span>createOrderSagaState<span class="o">)</span><span class="p">;</span>
                sagaParticipantDoneList.push<span class="o">(</span>sagaParticipant<span class="o">)</span><span class="p">;</span>

            <span class="o">}</span>catch <span class="o">(</span>BusinessException e<span class="o">){</span>
                sagaParticipantDoneList.pop<span class="o">()</span>.compensatingTransaction<span class="o">(</span>createOrderSagaState<span class="o">)</span><span class="p">;</span>
                throw e<span class="p">;</span>
            <span class="o">}</span>

        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="WebAPI.html" class="btn btn-neutral float-right" title="Web API" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Docker.html" class="btn btn-neutral float-left" title="Docker" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, nosey

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>