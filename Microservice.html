

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="ja" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="ja" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Microservice &mdash; test_sphinx 1.0.0 ドキュメント</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript" src="_static/translations.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="検索" href="search.html" />
    <link rel="next" title="Microservice Communication" href="Microservice-Communication.html" />
    <link rel="prev" title="Docker" href="Docker.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> test_sphinx
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Spring-Core.html">Spring Core</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spring-Boot.html">Spring Boot</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spring-Session.html">Spring Session</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spring-Security.html">Spring Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spring-MVC.html">Spring MVC</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spring-Web.html">Spring Web</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spring-Data.html">Spring Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="MyBatis3.html">MyBatis3</a></li>
<li class="toctree-l1"><a class="reference internal" href="Spring-to-Spring-boot.html">SpringからSpring bootへの移行</a></li>
<li class="toctree-l1"><a class="reference internal" href="Docker.html">Docker</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Microservice</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#ec">ECサイトのマイクロサービスアーキテクチャ化</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">サービス分割単位</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">各サービスの主な業務機能</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">各サービスの主なシステム機能</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">システム全体構成（ヘキサゴナルアーキテクチャ）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#goods-servicerest-api">Goods ServiceのREST APIの設計と実装</a></li>
<li class="toctree-l3"><a class="reference internal" href="#account-serivcerest-api">Account SerivceのREST APIの設計と実装</a></li>
<li class="toctree-l3"><a class="reference internal" href="#order-serivcesaga-transaction">Order SerivceのSaga Transactionの設計と実装</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id5">ECサイトの配達サービス拡張</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id6">追加の業務機能</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">システム全体構成（ヘキサゴナルアーキテクチャ）</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">追加のシステム機能</a></li>
<li class="toctree-l3"><a class="reference internal" href="#spring">追加のSpringライブラリ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id9">追加のインフラ</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">設計概要</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id11">チャネルの設計</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id12">コマンドの設計</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id13">コマンド、チャネル、コマンド送信処理の実装</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id14">コマンド受信処理、レスポンスメッセージ定義の実装</a></li>
<li class="toctree-l3"><a class="reference internal" href="#saga">Sagaトランザクション設計と実装</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id15">ECサイトのフロントエンド改善</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id16">追加の業務機能</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id17">追加のシステム機能</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="Microservice-Communication.html">Microservice Communication</a></li>
<li class="toctree-l1"><a class="reference internal" href="WebAPI.html">Web API</a></li>
<li class="toctree-l1"><a class="reference internal" href="git.html">git</a></li>
<li class="toctree-l1"><a class="reference internal" href="Lombok.html">Lombok</a></li>
<li class="toctree-l1"><a class="reference internal" href="Linux.html">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="Sphinx.html">Sphinx</a></li>
</ul>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="UX.html">UX</a></li>
<li class="toctree-l1"><a class="reference internal" href="UI.html">UI</a></li>
<li class="toctree-l1"><a class="reference internal" href="Design-Process.html">デザインプロセス</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">test_sphinx</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Microservice</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/Microservice.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="microservice">
<h1>Microservice<a class="headerlink" href="#microservice" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="ec">
<h2>ECサイトのマイクロサービスアーキテクチャ化<a class="headerlink" href="#ec" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>terasolunaチュートリアルの簡易ECサイトを使って、マイクロサービスアーキテクチャ移行検証を行った。</p>
<div class="section" id="id1">
<h3>サービス分割単位<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>terasolunaチュートリアルの簡易ECサイトを、Goods Service（商品）と、Account Serive（アカウント）、Order Service（注文）に機能分割する。
Order Serviceは、Goods ServiceとAccount Serviceを呼び出すBFFであり、
Account ServiceとGoods Serviceは、BFFから呼び出される、マイクロサービスである。
マイクロサービスを跨いだ、トランザクション処理が発生しないように分割する。例えば、簡易ECサイトの場合だと、Goods Serivceのトランザクション
はAccount Serviceが持つデータを更新しないようにする（逆方向も同様）。</p>
<div class="figure align-center" id="id18">
<a class="reference internal image-reference" href="./_static/img/overview.png"><img alt="" src="./_static/img/overview.png" /></a>
<p class="caption"><span class="caption-text">全体イメージ（モノリシック vs マイクロサービス）</span></p>
</div>
</div>
<div class="section" id="id2">
<h3>各サービスの主な業務機能<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="31%" />
<col width="31%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">サービス</th>
<th class="head">機能</th>
<th class="head">内容</th>
<th class="head">備考</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Order</td>
<td>商品注文</td>
<td>カートに入った商品の購入手続きを行う</td>
<td>注文確定処理時に、商品の在庫確認と購入者の購入額上限をチェック</td>
</tr>
<tr class="row-odd"><td>Goods</td>
<td>商品取得</td>
<td>指定した商品IDに一致する商品を取得する</td>
<td>--</td>
</tr>
<tr class="row-even"><td>Goods</td>
<td>商品カテゴリ取得</td>
<td>指定した商品カテゴリに一致する商品を取得する</td>
<td>--</td>
</tr>
<tr class="row-odd"><td>Goods</td>
<td>商品情報更新</td>
<td>商品情報（商品詳細、在庫情報等）を更新する</td>
<td>商品情報更新時、在庫がマイナスでないかチェック</td>
</tr>
<tr class="row-even"><td>Account</td>
<td>アカウント取得</td>
<td>指定したEmailアドレスやIDに一致するアカウントを取得する</td>
<td>--</td>
</tr>
<tr class="row-odd"><td>Account</td>
<td>アカウント情報更新</td>
<td>アカウント情報（ユーザ基本情報、累積購入額、購入額上限等）を更新する</td>
<td>アカウント情報更新時、累積購入額が購入額上限を上回らないかチェック</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id3">
<h3>各サービスの主なシステム機能<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="44%" />
<col width="44%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">サービス</th>
<th class="head">機能</th>
<th class="head">内容</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Order</td>
<td>認証・認可</td>
<td>Accountサービスが保持するアカウント情報とSpring Securityをつかって認証・認可機能を提供する</td>
</tr>
<tr class="row-odd"><td>Order</td>
<td>分散トランザクション管理</td>
<td>商品注文機能が扱う、GoodsとAccountが保持するデータの整合性担保のため、Sagaを使った分散トランザクション管理を行う</td>
</tr>
<tr class="row-even"><td>Goods</td>
<td>RET APIサービス</td>
<td>業務機能をREST APIで提供する</td>
</tr>
<tr class="row-odd"><td>Account</td>
<td>REST APIサービス</td>
<td>業務機能をREST APIで提供する</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id4">
<h3>システム全体構成（ヘキサゴナルアーキテクチャ）<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="figure align-center" id="id19">
<a class="reference internal image-reference" href="./_static/img/hexArchitecture.png"><img alt="" src="./_static/img/hexArchitecture.png" /></a>
<p class="caption"><span class="caption-text">システム全体構成（ヘキサゴナルアーキテクチャ）</span></p>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">ヘキサゴナルアーキテクチャでは、内側の中央の六角形はBusiness logicを表し、外側の六角形は外部とのAdapterを表す。
ポイントは、Business logicは、外側のAdapterには依存しないということ。</p>
</div>
<p>参考: Microservice Patterns, Chris Richardson</p>
</div>
<div class="section" id="goods-servicerest-api">
<h3>Goods ServiceのREST APIの設計と実装<a class="headerlink" href="#goods-servicerest-api" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><strong>API一覧</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="5%" />
<col width="19%" />
<col width="19%" />
<col width="19%" />
<col width="19%" />
<col width="19%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">機能</th>
<th class="head">method</th>
<th class="head">Query Parameter</th>
<th class="head">Request Body</th>
<th class="head">Response Body</th>
<th class="head">Status Code</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>カテゴリIDによる商品一覧取得</td>
<td>get</td>
<td>categoryId/offset/limit</td>
<td>--</td>
<td>GoodsResource[]</td>
<td>200/400</td>
</tr>
<tr class="row-odd"><td>商品IDによる商品詳細取得</td>
<td>get</td>
<td>goodsId</td>
<td>--</td>
<td>GoodsResource</td>
<td>200/400</td>
</tr>
<tr class="row-even"><td>商品情報更新</td>
<td>put</td>
<td>goodsId</td>
<td>Goods</td>
<td>Goods[]</td>
<td>200/400</td>
</tr>
</tbody>
</table>
<p><strong>実装概要</strong></p>
<p>MVCアプリケーションと比べた場合、REST APIサービスでは、以下の特徴がある。
Serviceクラス以下のクラスについては、Webアプリケーションと同様の実装となるため、
元々の簡易ECサイトのソースコードをそのまま使っている。
一方、Controllerクラスにおいて、MVCアプリケーションでは、画面からの入力をFormクラスで受け取り、Viewを返すが、
REST APIサービスでは、クエリパラメータ等でREST Clietからの入力を受け取り、Resourceオブジェクトを返す。</p>
<p><strong>Contorollerクラス</strong></p>
<p>以下は「カテゴリIDによる商品一覧取得」のAPIに対応するContorollerクラスの抜粋である。&#64;RequestParamで受け取ったクエリパラーメータの値を、Serviceクラスに渡し
ModelクラスのGoodsのListを受け取っている。それを、Mapperを使ってResourceクラスに変換している。
なお、以下のAPIは、offsetとlimitの指定で、指定したカテゴリIDに一致したGoodsの一部を返却しているが、
総件数については、レスポンスヘッダーに入れている。
また、BusinessExceptionは、throwsし例外ハンドラに例外処理は、委譲している。</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//omitted</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">&quot;api/v1&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoodsRestController</span> <span class="p">{</span>

<span class="nd">@Autowired</span>
<span class="n">GoodsService</span> <span class="n">goodsService</span><span class="p">;</span>

<span class="nd">@Autowired</span>
<span class="n">Mapper</span> <span class="n">beanMapper</span><span class="p">;</span>

<span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/goods&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Goods</span><span class="o">&gt;&gt;</span> <span class="nf">getGoodsByCategoryId</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;categoryId&quot;</span><span class="p">,</span> <span class="n">defaultValue</span> <span class="o">=</span> <span class="s">&quot;1&quot;</span><span class="p">)</span> <span class="n">Integer</span> <span class="n">categoryId</span><span class="p">,</span>
                                                        <span class="nd">@RequestParam</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;offset&quot;</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="n">defaultValue</span> <span class="o">=</span> <span class="s">&quot;0&quot;</span><span class="p">)</span> <span class="n">Integer</span> <span class="n">offset</span><span class="p">,</span>
                                                        <span class="nd">@RequestParam</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;limit&quot;</span><span class="p">,</span> <span class="n">required</span> <span class="o">=</span> <span class="kc">false</span><span class="p">,</span> <span class="n">defaultValue</span> <span class="o">=</span> <span class="s">&quot;10&quot;</span><span class="p">)</span> <span class="n">Integer</span> <span class="n">limit</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BusinessException</span> <span class="p">{</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Goods</span><span class="o">&gt;</span> <span class="n">goodsList</span> <span class="o">=</span> <span class="n">goodsService</span><span class="p">.</span><span class="na">findByCategoryId</span><span class="p">(</span><span class="n">categoryId</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">limit</span><span class="p">);</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">GoodsResource</span><span class="o">&gt;</span> <span class="n">goodsResourcesList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">Goods</span> <span class="n">goods</span> <span class="p">:</span> <span class="n">goodsList</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">goodsResourcesList</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">goods</span><span class="p">,</span> <span class="n">GoodsResource</span><span class="p">.</span><span class="na">class</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="n">HttpHeaders</span> <span class="n">headers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpHeaders</span><span class="p">();</span>
    <span class="n">Long</span> <span class="n">total</span> <span class="o">=</span> <span class="n">goodsService</span><span class="p">.</span><span class="na">getTotalWithCategoryId</span><span class="p">(</span><span class="n">categoryId</span><span class="p">);</span>
    <span class="n">headers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;X-Total-Count&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">.</span><span class="na">valueOf</span><span class="p">(</span><span class="n">total</span><span class="p">));</span>

    <span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">&lt;&gt;</span><span class="p">(</span>
            <span class="n">goodsList</span><span class="p">,</span>
            <span class="n">headers</span><span class="p">,</span>
            <span class="n">HttpStatus</span><span class="p">.</span><span class="na">OK</span><span class="p">);</span>

<span class="p">}</span>

<span class="c1">//omitted</span>
</pre></div>
</td></tr></table></div>
<p><strong>Resourceクラス</strong></p>
<p>MVCアプリケーションには存在しないREST APIサービス特有のクラスである。
サービス内部の業務ロジックで用いるドメインオブジェクトと、サービス外部提向けに提供する際の、情報は異る可能性を考慮し、
Modelクラスとは別に、Resourceクラスを用意する。</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//omitted</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoodsResource</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">categoryId</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">price</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">stock</span><span class="p">;</span>

<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Modelクラス</strong></p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//omitted</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Goods</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">description</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">categoryId</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">price</span><span class="p">;</span>

    <span class="kd">private</span> <span class="kt">int</span> <span class="n">stock</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">equals</span><span class="p">(</span><span class="n">Object</span> <span class="n">obj</span><span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">obj</span> <span class="k">instanceof</span> <span class="n">Goods</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">id</span><span class="p">.</span><span class="na">equals</span><span class="p">(((</span><span class="n">Goods</span><span class="p">)</span> <span class="n">obj</span><span class="p">).</span><span class="na">getId</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">hashCode</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="p">.</span><span class="na">hashCode</span><span class="p">();</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>Serivceクラス</strong></p>
<p>以下は商品情報更新処理のServiceクラスのメソッドである。REST Clientから送られたきた商品のStockが、0を下回るとき、
ビジネス例外をthrowする。そうでない場合は、Repositoryクラスを呼び、データを永続化する。</p>
<p><strong>Repositoryクラス</strong></p>
<p>MyBatis3を使った、Repositoryクラスの実装である。</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//omitted</span>

<span class="nd">@Repository</span>
<span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GoodsRepository</span> <span class="p">{</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Goods</span><span class="o">&gt;</span> <span class="nf">findPageByCategoryId</span><span class="p">(</span><span class="n">Integer</span> <span class="n">categoryId</span><span class="p">,</span> <span class="n">RowBounds</span> <span class="n">rowBounds</span><span class="p">);</span>

    <span class="n">Goods</span> <span class="nf">findById</span><span class="p">(</span><span class="n">String</span> <span class="n">id</span><span class="p">);</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="nf">getAllCategories</span><span class="p">();</span>

    <span class="kt">long</span> <span class="nf">countByCategoryId</span><span class="p">(</span><span class="kt">int</span> <span class="n">categoryId</span><span class="p">);</span>

    <span class="kt">boolean</span> <span class="nf">updateById</span><span class="p">(</span><span class="n">Goods</span> <span class="n">goods</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>MyBatisマッピングファイル</strong></p>
<p>Modelクラスのオブジェクトを返り値として受け取りたい場合は、
resultMapで、オブジェクトフィールド名とテーブルのカラム名を対応づける。</p>
<div class="highlight-xml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="cp">&lt;!DOCTYPE mapper PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
<span class="cp">        &quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
<span class="nt">&lt;mapper</span> <span class="na">namespace=</span><span class="s">&quot;com.example.good.domain.repository.GoodsRepository&quot;</span><span class="nt">&gt;</span>

    <span class="nt">&lt;resultMap</span> <span class="na">id=</span><span class="s">&quot;goodsResultMap&quot;</span> <span class="na">type=</span><span class="s">&quot;com.example.good.domain.model.Goods&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;id</span> <span class="na">property=</span><span class="s">&quot;id&quot;</span> <span class="na">column=</span><span class="s">&quot;goods_id&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;name&quot;</span> <span class="na">column=</span><span class="s">&quot;goods_name&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;description&quot;</span> <span class="na">column=</span><span class="s">&quot;description&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;categoryId&quot;</span> <span class="na">column=</span><span class="s">&quot;category_id&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;price&quot;</span> <span class="na">column=</span><span class="s">&quot;price&quot;</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;result</span> <span class="na">property=</span><span class="s">&quot;stock&quot;</span> <span class="na">column=</span><span class="s">&quot;stock&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/resultMap&gt;</span>

    <span class="nt">&lt;select</span> <span class="na">id=</span><span class="s">&quot;findPageByCategoryId&quot;</span> <span class="na">parameterType=</span><span class="s">&quot;int&quot;</span> <span class="na">resultMap=</span><span class="s">&quot;goodsResultMap&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;![CDATA[</span>
<span class="cp">        SELECT</span>
<span class="cp">            goods_id,</span>
<span class="cp">            goods_name,</span>
<span class="cp">            description,</span>
<span class="cp">            category_id,</span>
<span class="cp">            price,</span>
<span class="cp">            stock</span>
<span class="cp">        FROM</span>
<span class="cp">            goods</span>
<span class="cp">        WHERE</span>
<span class="cp">            category_id = #{categoryId}</span>
<span class="cp">        ORDER BY</span>
<span class="cp">            goods_id</span>
<span class="cp">        ]]&gt;</span>
    <span class="nt">&lt;/select&gt;</span>

//omitted
</pre></div>
</td></tr></table></div>
<p><strong>例外ハンドリングクラス</strong></p>
<p>以下は、Contorollerクラスで発生する例外のハンドリングクラスである。&#64;ControllerAdviceのアノテーションによって、
Contorollerクラス内の各メソッドで発生する例外を横断してハンドリングできる。
以下は、ビジネス例外をハンドリングするメソッドの例である。Serviceクラスの実装サンプルで示したように、
エラーコード、エラーメッセージが格納されているbusinessExceptionをbodyに埋め込み、400エラー（BAD REQUEST）を
REST CLIENTに返している。</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//omitted</span>

<span class="nd">@ControllerAdvice</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommonExceptionHandler</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">Mapper</span> <span class="n">beanMapper</span><span class="p">;</span>

    <span class="nd">@ExceptionHandler</span><span class="p">(</span><span class="n">BusinessException</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">ResponseEntity</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="nf">handleBusinessException</span><span class="p">(</span><span class="n">BusinessException</span> <span class="n">businessException</span><span class="p">){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ResponseEntity</span><span class="o">&lt;&gt;</span><span class="p">(</span>
                <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">businessException</span><span class="p">,</span> <span class="n">BusinessExceptionResponse</span><span class="p">.</span><span class="na">class</span><span class="p">),</span>
                <span class="n">HttpStatus</span><span class="p">.</span><span class="na">BAD_REQUEST</span><span class="p">);</span>

    <span class="p">}</span>

<span class="c1">//omitted</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="account-serivcerest-api">
<h3>Account SerivceのREST APIの設計と実装<a class="headerlink" href="#account-serivcerest-api" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><strong>API一覧</strong></p>
<table border="1" class="docutils">
<colgroup>
<col width="5%" />
<col width="19%" />
<col width="19%" />
<col width="19%" />
<col width="19%" />
<col width="19%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">機能</th>
<th class="head">method</th>
<th class="head">Query Parameter</th>
<th class="head">Request Body</th>
<th class="head">Response Body</th>
<th class="head">Status Code</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>アカウントIDによるアカウント取得</td>
<td>get</td>
<td>id</td>
<td>--</td>
<td>AccountResource</td>
<td>200/400</td>
</tr>
<tr class="row-odd"><td>Emailによるアカウント取得</td>
<td>post</td>
<td>--</td>
<td>LoginId</td>
<td>AccountResource</td>
<td>200/400</td>
</tr>
<tr class="row-even"><td>アカウント作成</td>
<td>post</td>
<td>--</td>
<td>AccountCreateResource</td>
<td>※locationヘッダーに、作成したアカウントのURIを付与</td>
<td>200/400</td>
</tr>
<tr class="row-odd"><td>アカウント更新</td>
<td>put</td>
<td>--</td>
<td>AccountUpdateResource</td>
<td>--</td>
<td>204/400</td>
</tr>
</tbody>
</table>
<p><strong>Contorollerクラス</strong></p>
<p>以下は「アカウント更新」のAPIに対応するContorollerクラスの実装である。
Goods Seriviceとの実装上の違いは、リクエストボディの引数に、&#64;Validatedを付けて、バリデーション処理を行っている。
バリデーション例外が発生した場合は、例外ハンドラクラスで、ハンドリングを行う。</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//omitted</span>

<span class="nd">@PutMapping</span><span class="p">(</span><span class="s">&quot;/account&quot;</span><span class="p">)</span>
<span class="nd">@ResponseStatus</span><span class="p">(</span><span class="n">HttpStatus</span><span class="p">.</span><span class="na">NO_CONTENT</span><span class="p">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateAccount</span><span class="p">(</span><span class="nd">@RequestParam</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;id&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">id</span><span class="p">,</span>
                        <span class="nd">@Validated</span> <span class="nd">@RequestBody</span> <span class="n">AccountUpdateResource</span> <span class="n">accountUpdateResource</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BusinessException</span><span class="p">{</span>
    <span class="n">Account</span> <span class="n">account</span> <span class="o">=</span> <span class="n">beanMapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">accountUpdateResource</span><span class="p">,</span> <span class="n">Account</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
    <span class="n">account</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
    <span class="n">accountService</span><span class="p">.</span><span class="na">update</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//omitted</span>
</pre></div>
</td></tr></table></div>
<p><strong>Resourceクラス</strong></p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//omitted</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">AccountUpdateResource</span> <span class="kd">implements</span>  <span class="n">Serializable</span><span class="p">{</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="p">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Size</span><span class="p">(</span><span class="n">min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max</span> <span class="o">=</span> <span class="mi">255</span><span class="p">)</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="p">;</span>

<span class="c1">//omitted</span>
</pre></div>
</td></tr></table></div>
<p><strong>Serivceクラス</strong></p>
<p>以下は、アカウント更新処理メソッドの実装である。REST CLIENTから累計購入金額が購入額上限を上回った場合、
ビジネス例外をthrowする。そうでない場合は、Repositoryクラスを呼び、データを永続化する。</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//omitted</span>

<span class="kd">public</span> <span class="kt">void</span> <span class="nf">update</span><span class="p">(</span><span class="n">Account</span> <span class="n">account</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BusinessException</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">parseInt</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getCreditCharge</span><span class="p">())</span> <span class="o">&gt;</span> <span class="n">parseInt</span><span class="p">(</span><span class="n">account</span><span class="p">.</span><span class="na">getCreditLimit</span><span class="p">())){</span>
        <span class="n">String</span> <span class="n">errorCode</span> <span class="o">=</span> <span class="s">&quot;BE0003&quot;</span><span class="p">;</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="n">BusinessException</span><span class="p">(</span><span class="n">errorCode</span><span class="p">,</span> <span class="n">messageSource</span><span class="p">.</span><span class="na">getMessage</span><span class="p">(</span>
                <span class="n">errorCode</span><span class="p">,</span> <span class="k">new</span> <span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="n">account</span><span class="p">.</span><span class="na">getCreditCharge</span><span class="p">(),</span> <span class="n">account</span><span class="p">.</span><span class="na">getCreditLimit</span><span class="p">()},</span> <span class="n">Locale</span><span class="p">.</span><span class="na">getDefault</span><span class="p">()));</span>

    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="n">accountRepository</span><span class="p">.</span><span class="na">updateById</span><span class="p">(</span><span class="n">account</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>例外ハンドリングクラス</strong></p>
</div>
<div class="section" id="order-serivcesaga-transaction">
<h3>Order SerivceのSaga Transactionの設計と実装<a class="headerlink" href="#order-serivcesaga-transaction" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>商品注文処理を、Goods ServiceとAccount Serviceを呼び出して実現する。
ポイントは、Goods Serviceもしくは、Account Serviceで例外が発生した際に、
適切に補償トランザクションを実行しデータの整合性を保つことである。</p>
<p><strong>Sagaにおける補償トランザクション</strong></p>
<p>補償トランザクションとは、フォーワードトランザクション実行で失敗が発生した際、
失敗以前に行った変更を、打ち消すトランザクションである。
例えば、以下の例では、フォーワードトランザクションTn+1が失敗した場合、補償トランザクションCnからC1を実行している。</p>
<div class="figure align-center" id="id20">
<a class="reference internal image-reference" href="./_static/img/conpensatingTransaction.png"><img alt="" src="./_static/img/conpensatingTransaction.png" /></a>
<p class="caption"><span class="caption-text">補償トランザクションの実行イメージ</span></p>
</div>
<p>引用: Microservice Patterns, Chris Richardson</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">補償トランザクションは、フォーワードトランザクションと逆順で実行する点に注意する。</p>
</div>
<p><strong>フォーワードトランザクションと補償トランザクションの一覧</strong></p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="14%" />
<col width="29%" />
<col width="29%" />
<col width="29%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Step</th>
<th class="head">Service</th>
<th class="head">Forward Transaction</th>
<th class="head">Compensating Transaction</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>Order Service</td>
<td>createOrder()</td>
<td>rejectOrder()</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>Order Service</td>
<td>createOrderLines()</td>
<td>deleteOrderLines()</td>
</tr>
<tr class="row-even"><td>3</td>
<td>Goods Service</td>
<td>decreaseStock()</td>
<td>increaeStok()</td>
</tr>
<tr class="row-odd"><td>4</td>
<td>Account Service</td>
<td>addCreditCharge()</td>
<td>substractCreditCharge()</td>
</tr>
<tr class="row-even"><td>5</td>
<td>Order Service</td>
<td>approveOrdre()</td>
<td>--</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p><strong>実装概要</strong></p>
<p>Order ServiceのServiceクラスから、Sagaの実行に必要な情報をSagaStateクラスに格納した後、
SagaManagerクラスから実行。Sagaの定義（各STEPのトランザクションの定義とSTEPの順序の定義）は、
SagaPaticipantクラスとSagaDefinitionクラスを使ってDIする。</p>
<div class="figure align-center" id="id21">
<a class="reference internal image-reference" href="./_static/img/sagaSequence.png"><img alt="" src="./_static/img/sagaSequence.png" /></a>
<p class="caption"><span class="caption-text">処理シーケンスイメージ</span></p>
</div>
<p><strong>SagaPaticipantクラス</strong></p>
<p>以下の、フォーワードトランザクションと、補償トランザクションのメソッドの組み合わせを、
インタフェース定義している。ビジネス例外をthrowし、SagaParticipantを実行するSagaManagerで例外ハンドリングできるようにする。</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//omitted</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SagaParticipant</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="nf">forwardTransaction</span><span class="p">(</span><span class="n">CreateOrderSagaState</span> <span class="n">createOrderSagaState</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BusinessException</span><span class="p">;</span>
    <span class="kt">void</span> <span class="nf">compensatingTransaction</span><span class="p">(</span><span class="n">CreateOrderSagaState</span> <span class="n">createOrderSagaState</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BusinessException</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>Sagaトランザクションの各STEPは、自身が行いたい処理を実装する。
以下は、商品注文時、商品在庫を減らす処理をフォーワードトランザクションとして定義し、
商品在庫を増やす処理を補償トランザクションで定義している。</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//omitted</span>

<span class="nd">@Component</span><span class="p">(</span><span class="s">&quot;goodsServiceParticipant&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">GoodsServiceParticipant</span> <span class="kd">implements</span> <span class="n">SagaParticipant</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">GoodsService</span> <span class="n">goodsService</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">forwardTransaction</span><span class="p">(</span><span class="n">CreateOrderSagaState</span> <span class="n">createOrderSagaState</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BusinessException</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">OrderLine</span> <span class="n">orderLine</span> <span class="p">:</span> <span class="n">createOrderSagaState</span><span class="p">.</span><span class="na">getOrderLines</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">goodsService</span><span class="p">.</span><span class="na">decreaseStock</span><span class="p">(</span><span class="n">orderLine</span><span class="p">.</span><span class="na">getGoods</span><span class="p">(),</span> <span class="n">orderLine</span><span class="p">.</span><span class="na">getQuantity</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">compensatingTransaction</span><span class="p">(</span><span class="n">CreateOrderSagaState</span> <span class="n">createOrderSagaState</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BusinessException</span><span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">OrderLine</span> <span class="n">orderLine</span> <span class="p">:</span> <span class="n">createOrderSagaState</span><span class="p">.</span><span class="na">getOrderLines</span><span class="p">())</span> <span class="p">{</span>
            <span class="n">goodsService</span><span class="p">.</span><span class="na">increaseStock</span><span class="p">(</span><span class="n">orderLine</span><span class="p">.</span><span class="na">getGoods</span><span class="p">(),</span> <span class="n">orderLine</span><span class="p">.</span><span class="na">getQuantity</span><span class="p">());</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>SagaDefinitionクラス</strong></p>
<p>各SagaPaticipantクラスを組み合わせて、Sagaの定義を行う。
以下では、各SagaPaticipantの実装クラスを引数にして、List&lt;SagaParticipant&gt;型でSagaを定義している。
DIしておき、Sagaを実際に実行する、SagaManagerクラスから使えるようにしておく。</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//omitted</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SagaConfig</span> <span class="p">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">CreateOrderSaga</span> <span class="nf">createOrderSaga</span><span class="p">(</span><span class="n">OrderServiceParticipant</span> <span class="n">orderServiceParticipant</span><span class="p">,</span>
                                        <span class="n">GoodsServiceParticipant</span> <span class="n">goodsServiceParticipant</span><span class="p">,</span>
                                        <span class="n">AccountServiceParticipant</span> <span class="n">accountServiceParticipant</span><span class="p">){</span>
        <span class="n">CreateOrderSaga</span> <span class="n">createOrderSaga</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CreateOrderSaga</span><span class="p">();</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">SagaParticipant</span><span class="o">&gt;</span> <span class="n">sagaDefinition</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;</span><span class="p">();</span>
        <span class="n">sagaDefinition</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">orderServiceParticipant</span><span class="p">);</span>
        <span class="n">sagaDefinition</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">goodsServiceParticipant</span><span class="p">);</span>
        <span class="n">sagaDefinition</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">accountServiceParticipant</span><span class="p">);</span>
        <span class="n">createOrderSaga</span><span class="p">.</span><span class="na">setSagaDefinition</span><span class="p">(</span><span class="n">sagaDefinition</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">createOrderSaga</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>SagaStateクラス</strong></p>
<p>Sagaの実行時に必要な状態を保持するクラス。以下は、商品注文処理に必要な、
注文商品情報やアカウント情報を保持している。</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//omitted</span>

<span class="nd">@Data</span>
<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CreateOrderSagaState</span> <span class="kd">extends</span> <span class="n">SagaState</span><span class="p">{</span>
    <span class="kd">private</span> <span class="n">Order</span> <span class="n">order</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">OrderLine</span><span class="o">&gt;</span> <span class="n">orderLines</span><span class="p">;</span>
    <span class="kd">private</span> <span class="n">Account</span> <span class="n">account</span><span class="p">;</span>


    <span class="kd">public</span> <span class="nf">CreateOrderSagaState</span><span class="p">(</span><span class="n">Order</span> <span class="n">order</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">OrderLine</span><span class="o">&gt;</span> <span class="n">orderLines</span><span class="p">,</span> <span class="n">Account</span> <span class="n">account</span><span class="p">){</span>
        <span class="kd">super</span><span class="p">();</span>
        <span class="k">this</span><span class="p">.</span><span class="na">order</span> <span class="o">=</span> <span class="n">order</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">orderLines</span> <span class="o">=</span> <span class="n">orderLines</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="na">account</span> <span class="o">=</span> <span class="n">account</span><span class="p">;</span>

    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p><strong>SagaManagerクラス</strong></p>
<p>Sagaの定義と状態を使って、実際にSagaを実行するクラス。
各Stepの実行事に発生するビジネス例外をキャッチした場合は、完了済のSTEPの補償トランザクションを
逆順に実行していく。補償トランザクションを実行した場合は、ビジネス例外をthrowし、Controllerクラスで例外ハンドリングし
ユーザに注文完了できないことを通知する。</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//omitted</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CreateOrderSagaManager</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">MessageSource</span> <span class="n">messageSource</span><span class="p">;</span>


    <span class="nd">@Autowired</span>
    <span class="n">CreateOrderSaga</span> <span class="n">createOrderSaga</span><span class="p">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">create</span> <span class="p">(</span><span class="n">CreateOrderSagaState</span> <span class="n">createOrderSagaState</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BusinessException</span><span class="p">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">SagaParticipant</span><span class="o">&gt;</span> <span class="n">sagaDefinition</span> <span class="o">=</span> <span class="n">createOrderSaga</span><span class="p">.</span><span class="na">getSagaDefinition</span><span class="p">();</span>
        <span class="n">Deque</span><span class="o">&lt;</span><span class="n">SagaParticipant</span><span class="o">&gt;</span> <span class="n">sagaParticipantDoneList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayDeque</span><span class="o">&lt;&gt;</span><span class="p">();</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">SagaParticipant</span> <span class="n">sagaParticipant</span> <span class="p">:</span> <span class="n">sagaDefinition</span><span class="p">){</span>
            <span class="k">try</span><span class="p">{</span>
                <span class="n">sagaParticipant</span><span class="p">.</span><span class="na">forwardTransaction</span><span class="p">(</span><span class="n">createOrderSagaState</span><span class="p">);</span>
                <span class="n">sagaParticipantDoneList</span><span class="p">.</span><span class="na">push</span><span class="p">(</span><span class="n">sagaParticipant</span><span class="p">);</span>

            <span class="p">}</span><span class="k">catch</span> <span class="p">(</span><span class="n">BusinessException</span> <span class="n">e</span><span class="p">){</span>
                <span class="n">sagaParticipantDoneList</span><span class="p">.</span><span class="na">pop</span><span class="p">().</span><span class="na">compensatingTransaction</span><span class="p">(</span><span class="n">createOrderSagaState</span><span class="p">);</span>
                <span class="k">throw</span> <span class="n">e</span><span class="p">;</span>
            <span class="p">}</span>

        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div>
<div class="section" id="id5">
<h2>ECサイトの配達サービス拡張<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Delivery Serviceとの連携を、注文作成Sagaトランザクションに追加し、注文完了時に、
配達予定日がわかるようにする。また、ユーザは、自身の注文の配達予定を調べることのできる一覧表示機能と、チャット問い合わせ機能を追加する。
一つのSaga Transaction内で連携するサービス増加による可用性低下を
防ぐため、BFFであるOrder Serviceから各マイクロサービスの呼び出しは、Message Brokerを経由した非同期通信に変更する。</p>
<div class="section" id="id6">
<h3>追加の業務機能<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="31%" />
<col width="31%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">サービス</th>
<th class="head">機能</th>
<th class="head">内容</th>
<th class="head">備考</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Delivery</td>
<td>配達計画一覧表示</td>
<td>指定したメールアドレスに一致する注文の配達計画一覧を表示する</td>
<td>--</td>
</tr>
<tr class="row-odd"><td>Delivery</td>
<td>配達計画チャット問い合わせ</td>
<td>指定した注文IDに一致する配達計画をチャット形式で回答する</td>
<td>--</td>
</tr>
<tr class="row-even"><td>Delivery</td>
<td>配達計画作成</td>
<td>注文の配達計画を作成する</td>
<td>検証用に配達計画作成は一定の確率で失敗するようにする。</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id7">
<h3>システム全体構成（ヘキサゴナルアーキテクチャ）<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="figure align-center" id="id22">
<a class="reference internal image-reference" href="./_static/img/AsyncArchitecture.png"><img alt="" src="./_static/img/AsyncArchitecture.png" /></a>
<p class="caption"><span class="caption-text">システム全体構成（ヘキサゴナルアーキテクチャ）</span></p>
</div>
</div>
<div class="section" id="id8">
<h3>追加のシステム機能<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="31%" />
<col width="31%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">サービス</th>
<th class="head">機能</th>
<th class="head">内容</th>
<th class="head">備考</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>全サービス</td>
<td>非同期通信</td>
<td>マイクロサービス間の、メッセージブローカを経由した非同期通信</td>
<td>--</td>
</tr>
<tr class="row-odd"><td>全サービス</td>
<td>メッセージング</td>
<td>マイクロサービスの処理を呼び出すためのコマンドと処理結果の返信を、spring-messagingを使って定義する</td>
<td>--</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="spring">
<h3>追加のSpringライブラリ<a class="headerlink" href="#spring" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="31%" />
<col width="31%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">サービス</th>
<th class="head">ライブラリ名</th>
<th class="head">内容</th>
<th class="head">備考</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>全サービス</td>
<td>Spring Cloud Stream</td>
<td>スケーラブルでイベントドリブンなマイクロサービス連携を実現するメッセージングを実現するフレームワーク</td>
<td>--</td>
</tr>
<tr class="row-odd"><td>全サービス</td>
<td>spring-messaging</td>
<td>メッセージを抽象化するインタフェース</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id9">
<h3>追加のインフラ<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="31%" />
<col width="31%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">サービス</th>
<th class="head">インフラ</th>
<th class="head">内容</th>
<th class="head">備考</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>全サービス</td>
<td>Message Broker</td>
<td>--</td>
<td>各マイクロサービス間ごとに、チャネルを定義し、使用する。本検証では、RabbitMQを使用する。</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id10">
<h3>設計概要<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>RESTでは、URI、メソッド、クエリパラメータ等の組み合せで特定していた処理を、
メッセージングでは、チャネルとコマンドの組み合わせで処理で特定する。</p>
<p>RESTでは、RestOperationsで実現していたレスポンス機構、正常/異常のレスポンスの定義を、独自に定義する必要がある。
具体的には、メッセージ送信側は、レスポンス用のチャネルを定義し、それを受信側に伝える必要があるし、
送受信の両側で、レスポンスメッセージにおける正常/異常の定義を共有する必要もある。</p>
</div>
<div class="section" id="id11">
<h3>チャネルの設計<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="31%" />
<col width="31%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">分類</th>
<th class="head">チャネル</th>
<th class="head">内容</th>
<th class="head">備考</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>リクエスト</td>
<td>Account service command channel</td>
<td>アカウントサービスへのコマンドを送信するチャネル</td>
<td>リクエスト用のチャネルは、各マイクロサービス毎に定義する。</td>
</tr>
<tr class="row-odd"><td>リクエスト</td>
<td>Goods service command channel</td>
<td>商品サービスへのコマンドを送信するチャネル</td>
<td>リクエスト用のチャネルは、各マイクロサービス毎に定義する。</td>
</tr>
<tr class="row-even"><td>リクエスト</td>
<td>Delivery Service command channel</td>
<td>配達サービスへのコマンドを送信するチャネル</td>
<td>リクエスト用のチャネルは、各マイクロサービス毎に定義する。</td>
</tr>
<tr class="row-odd"><td>レスポンス</td>
<td>Create order saga reply channel</td>
<td>注文作成のSaga transaction内の各トランザクションの結果をマイクロサービスから受け取るチャネル</td>
<td>レスポンス用のチャネルは各Sagaトランザクションごとに定義する。</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id12">
<h3>コマンドの設計<a class="headerlink" href="#id12" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>//Todo 各サービスごとにコマンドを定義する。Serviceクラスのメソッドごとに定義すれば良いはず。</p>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="31%" />
<col width="31%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">サービス</th>
<th class="head">コマンド名</th>
<th class="head">内容</th>
<th class="head">備考</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Delivery</td>
<td>ScheduleDeliveryCommand</td>
<td>配達計画作成処理を呼び出すコマンド</td>
<td>--</td>
</tr>
<tr class="row-odd"><td>Delivery</td>
<td>CancelDeliveryCommand</td>
<td>配達計画キャンセル処理を呼び出すコマンド</td>
<td>--</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id13">
<h3>コマンド、チャネル、コマンド送信処理の実装<a class="headerlink" href="#id13" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>以下のようにCommandインタフェースを定義する。</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//omitted</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Command</span> <span class="p">{</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>実装クラスでは、各コマンド実行に必要なステート情報をフィールド定義する。
以下は、ScheduleDeliveryCommandの例。</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//omitted</span>

<span class="nd">@AllArgsConstructor</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@Builder</span>
<span class="nd">@Data</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ScheduleDeliveryCommand</span> <span class="kd">implements</span> <span class="n">Command</span><span class="p">,</span> <span class="n">Serializable</span> <span class="p">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">id</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">email</span><span class="p">;</span>

    <span class="kd">private</span> <span class="n">Date</span> <span class="n">orderDate</span><span class="p">;</span>

<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>以下は、メッセージ送信を実装した、Delivery ServiceのRepositoryクラスの実装。
&#64;EnableBinding(Source.class)の箇所で、チャネルを定義した、Source.classを指定している。
Sourceをインジェクションし、source.output()でチャネル定義を取ってきて、.send()で引数に指定したコマンドを送信する。
MessageBuilder.withPayload(command).build()で、Messageのペイロードに、commandを指定している。</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">//omitted</span>

<span class="kn">import</span> <span class="nn">org.springframework.cloud.stream.messaging.Source</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.support.MessageBuilder</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.stream.annotation.EnableBinding</span><span class="p">;</span>

<span class="nd">@Component</span>
<span class="nd">@EnableBinding</span><span class="p">(</span><span class="n">Source</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DeliveryRepositoryImpl</span> <span class="kd">implements</span> <span class="n">DeliveryRepository</span><span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">Source</span> <span class="n">source</span><span class="p">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">send</span><span class="p">(</span><span class="n">Command</span> <span class="n">command</span><span class="p">)</span> <span class="kd">throws</span> <span class="n">BusinessException</span> <span class="p">{</span>
        <span class="n">source</span><span class="p">.</span><span class="na">output</span><span class="p">().</span><span class="na">send</span><span class="p">(</span><span class="n">MessageBuilder</span><span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="n">command</span><span class="p">).</span><span class="na">build</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>以下はデフォルトで用意されている、チャネルの定義クラス。Outputという名称のチャネルが定義さている。</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">package</span> <span class="nn">org.springframework.cloud.stream.messaging</span><span class="p">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.cloud.stream.annotation.Output</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.MessageChannel</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Source</span> <span class="p">{</span>

    <span class="n">String</span> <span class="n">OUTPUT</span> <span class="o">=</span> <span class="s">&quot;output&quot;</span><span class="p">;</span>

    <span class="nd">@Output</span><span class="p">(</span><span class="n">Source</span><span class="p">.</span><span class="na">OUTPUT</span><span class="p">)</span>
    <span class="n">MessageChannel</span> <span class="nf">output</span><span class="p">();</span>

<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>以下は、application.ymlのSpring cloud streamに関する定義である。outputチャネルのdestination名の定義と、
RabbitMQの定義がある。</p>
<div class="highlight-yaml notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="nt">spring</span><span class="p">:</span>
  <span class="nt">cloud</span><span class="p">:</span>
    <span class="nt">stream</span><span class="p">:</span>
      <span class="nt">bindings</span><span class="p">:</span>
        <span class="nt">output</span><span class="p">:</span>
          <span class="nt">destination</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">hello</span>

  <span class="nt">rabbitmq</span><span class="p">:</span>
    <span class="nt">addresses</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">localhost:5672</span>
    <span class="nt">username</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">guest</span>
    <span class="nt">password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">guest</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="id14">
<h3>コマンド受信処理、レスポンスメッセージ定義の実装<a class="headerlink" href="#id14" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>以下は、コマンド受信時のCommandHandlerクラスの実装である。受け取ったコマンドに応じて、適切なServiceクラスのメソッドを呼ぶ。
&#64;SendTo(Source.OUTPUT)によって、指定したチャネルに、レスポンスメッセージを送信する。
レスポンスメッセージは、Serviceクラスのメソッド呼出で、正常に処理が終了した場合は、withSuccess()を呼出し、正常終了を返す。
例外が発生した場合は、withFailure()を呼出し、異常終了を返す。</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.springframework.cloud.stream.annotation.EnableBinding</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.stream.annotation.StreamListener</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.cloud.stream.messaging.Sink</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.handler.annotation.SendTo</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.Message</span><span class="p">;</span>

<span class="kn">import static</span> <span class="nn">com.example.delivery.apinfra.saga.command.common.CommandHandlerReplyBuilder.withSuccess</span><span class="p">;</span>

<span class="nd">@EnableBinding</span><span class="p">(</span><span class="n">Sink</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DeliveryCommandHandler</span> <span class="p">{</span>

    <span class="nd">@Autowired</span>
    <span class="n">Mapper</span> <span class="n">mapper</span><span class="p">;</span>

    <span class="nd">@Autowired</span>
    <span class="n">DeliveryService</span> <span class="n">deliveryService</span><span class="p">;</span>

    <span class="nd">@StreamListener</span><span class="p">(</span><span class="n">Sink</span><span class="p">.</span><span class="na">INPUT</span><span class="p">)</span>
    <span class="nd">@SendTo</span><span class="p">(</span><span class="n">Source</span><span class="p">.</span><span class="na">OUTPUT</span><span class="p">)</span>
    <span class="kd">public</span> <span class="n">Message</span> <span class="nf">receive</span><span class="p">(</span><span class="n">Command</span> <span class="n">command</span><span class="p">){</span>

        <span class="k">if</span><span class="p">(</span><span class="n">command</span> <span class="k">instanceof</span> <span class="n">ScheduleDeliveryCommand</span><span class="p">){</span>
            <span class="n">Delivery</span> <span class="n">delivery</span> <span class="o">=</span> <span class="n">mapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">Delivery</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
            <span class="n">deliveryService</span><span class="p">.</span><span class="na">schedule</span><span class="p">(</span><span class="n">delivery</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">withSuccess</span><span class="p">();</span>
        <span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="k">instanceof</span> <span class="n">CancelDeliveryCommand</span><span class="p">){</span>
            <span class="n">Delivery</span> <span class="n">delivery</span> <span class="o">=</span> <span class="n">mapper</span><span class="p">.</span><span class="na">map</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">Delivery</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
            <span class="n">deliveryService</span><span class="p">.</span><span class="na">cancel</span><span class="p">(</span><span class="n">delivery</span><span class="p">);</span>
        <span class="p">}</span>

    <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>以下は、レスポンスメッセージを定義するクラスの実装である。
Message型のレスポンスメッセージとして、ヘッダーに処理ステータス情報を付与している。</p>
<div class="highlight-java notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">org.springframework.messaging.Message</span><span class="p">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.messaging.support.MessageBuilder</span><span class="p">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CommandHandlerReplyBuilder</span> <span class="p">{</span>


    <span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Message</span> <span class="nf">with</span><span class="p">(</span><span class="n">T</span> <span class="n">reply</span><span class="p">,</span> <span class="n">CommandReplyOutcome</span> <span class="n">outcome</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">MessageBuilder</span> <span class="n">messageBuilder</span> <span class="o">=</span> <span class="n">MessageBuilder</span>
                <span class="p">.</span><span class="na">withPayload</span><span class="p">(</span><span class="n">reply</span><span class="p">)</span>
                <span class="p">.</span><span class="na">setHeader</span><span class="p">(</span><span class="n">ReplyMessageHeaders</span><span class="p">.</span><span class="na">REPLY_OUTCOME</span><span class="p">,</span> <span class="n">outcome</span><span class="p">.</span><span class="na">name</span><span class="p">())</span>
                <span class="p">.</span><span class="na">setHeader</span><span class="p">(</span><span class="n">ReplyMessageHeaders</span><span class="p">.</span><span class="na">REPLY_TYPE</span><span class="p">,</span> <span class="n">reply</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getName</span><span class="p">());</span>
        <span class="k">return</span> <span class="n">messageBuilder</span><span class="p">.</span><span class="na">build</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Message</span> <span class="nf">withSuccess</span><span class="p">(</span><span class="n">Object</span> <span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">with</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">CommandReplyOutcome</span><span class="p">.</span><span class="na">SUCCESS</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Message</span> <span class="nf">withSuccess</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">withSuccess</span><span class="p">(</span><span class="k">new</span> <span class="n">Success</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Message</span> <span class="nf">withFailure</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">withFailure</span><span class="p">(</span><span class="k">new</span> <span class="n">Failure</span><span class="p">());</span>
    <span class="p">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Message</span> <span class="nf">withFailure</span><span class="p">(</span><span class="n">Object</span> <span class="n">reply</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">with</span><span class="p">(</span><span class="n">reply</span><span class="p">,</span> <span class="n">CommandReplyOutcome</span><span class="p">.</span><span class="na">FAILURE</span><span class="p">);</span>
    <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>参考：<a class="reference external" href="https://github.com/eventuate-tram/eventuate-tram-core/tree/master/eventuate-tram-commands/src/main/java/io/eventuate/tram/commands">https://github.com/eventuate-tram/eventuate-tram-core/tree/master/eventuate-tram-commands/src/main/java/io/eventuate/tram/commands</a></p>
<p>上記リンクとの違いは、本検証用には、spring-messagingのMessageBuilderをそのまま使っている。</p>
</div>
<div class="section" id="saga">
<h3>Sagaトランザクション設計と実装<a class="headerlink" href="#saga" title="このヘッドラインへのパーマリンク">¶</a></h3>
</div>
</div>
<div class="section" id="id15">
<h2>ECサイトのフロントエンド改善<a class="headerlink" href="#id15" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id16">
<h3>追加の業務機能<a class="headerlink" href="#id16" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="31%" />
<col width="31%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">サービス</th>
<th class="head">機能</th>
<th class="head">内容</th>
<th class="head">備考</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Order</td>
<td>商品画像表示</td>
<td>指定したメールアドレスに一致する注文の配達計画一覧を表示する</td>
<td>--</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="id17">
<h3>追加のシステム機能<a class="headerlink" href="#id17" title="このヘッドラインへのパーマリンク">¶</a></h3>
<table border="1" class="docutils">
<colgroup>
<col width="8%" />
<col width="31%" />
<col width="31%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">サービス</th>
<th class="head">機能</th>
<th class="head">内容</th>
<th class="head">備考</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>全サービス</td>
<td>非同期通信</td>
<td>マイクロサービス間の、メッセージブローカを経由した非同期通信</td>
<td>--</td>
</tr>
<tr class="row-odd"><td>全サービス</td>
<td>メッセージング</td>
<td>マイクロサービスの処理を呼び出すためのコマンドと処理結果の返信を、spring-messagingを使って定義する</td>
<td>--</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Microservice-Communication.html" class="btn btn-neutral float-right" title="Microservice Communication" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Docker.html" class="btn btn-neutral float-left" title="Docker" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, nosey

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>